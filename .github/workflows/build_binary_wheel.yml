name: Build Binary Wheel (Windows)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-windows-wheel:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive  # Important: initialize glm submodule

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache pip packages
        uses: actions/cache@v4
        continue-on-error: true
        with:
          path: ~\AppData\Local\pip\Cache
          key: ${{ runner.os }}-pip-${{ hashFiles('setup.py') }}-${{ github.run_id }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ hashFiles('setup.py') }}-
            ${{ runner.os }}-pip-

      - name: Install CUDA Toolkit
        uses: Jimver/cuda-toolkit@v0.2.29
        with:
          cuda: '11.8.0'
          use-github-cache: 'false'
          use-local-cache: 'false'

      - name: Set up MSVC environment
        uses: ilammy/msvc-dev-cmd@v1

      - name: Verify MSVC setup
        run: |
          Write-Host "=== Setting up MSVC environment ==="
          Write-Host "Visual Studio path: $env:VSINSTALLDIR"
          Write-Host ""
          Write-Host "Verifying cl.exe is now in PATH:"
          where.exe cl.exe
        shell: powershell

      - name: Cache PyTorch
        uses: actions/cache@v4
        continue-on-error: true
        id: pytorch-cache
        with:
          path: ${{ env.pythonLocation }}\Lib\site-packages\torch*
          key: ${{ runner.os }}-pytorch-2.2.2-cu118-${{ env.pythonLocation }}
          restore-keys: |
            ${{ runner.os }}-pytorch-2.2.2-cu118-

      - name: Install PyTorch
        if: steps.pytorch-cache.outputs.cache-hit != 'true'
        run: |
          Write-Host "=== Installing PyTorch ==="
          pip install torch==2.2.2 --extra-index-url https://download.pytorch.org/whl/cu118
          python -c "import torch; print(f'PyTorch version: {torch.__version__}'); print(f'CUDA available: {torch.cuda.is_available()}')"
        shell: powershell

      - name: Verify PyTorch installation
        run: |
          Write-Host "=== Verifying PyTorch ==="
          python -c "import torch; print(f'PyTorch version: {torch.__version__}'); print(f'CUDA available: {torch.cuda.is_available()}')"
        shell: powershell

      - name: Install build dependencies
        run: |
          pip install wheel setuptools ninja
        shell: powershell

      - name: Build binary wheel
        run: |
          Write-Host "=== Building binary wheel with CUDA extensions ==="
          Write-Host "Build environment:"
          Write-Host "  CUDA_PATH: $env:CUDA_PATH"
          Write-Host "  TORCH_CUDA_ARCH_LIST: $env:TORCH_CUDA_ARCH_LIST"
          Write-Host "  MAX_JOBS: $env:MAX_JOBS"
          Write-Host ""

          python setup.py bdist_wheel > build.log 2>&1
          $buildExitCode = $LASTEXITCODE

          Write-Host "`n=== Build Output ==="
          Get-Content build.log

          if ($buildExitCode -ne 0) {
              Write-Host "`n=== BUILD FAILED (exit code: $buildExitCode) ==="
              exit $buildExitCode
          }

          Write-Host "`n=== Built wheel ==="
          $wheels = Get-ChildItem dist\*.whl
          foreach ($wheel in $wheels) {
              Write-Host "  Wheel: $($wheel.Name)"
              Write-Host "  Size: $([math]::Round($wheel.Length / 1MB, 2)) MB"
          }
        shell: powershell
        env:
          TORCH_CUDA_ARCH_LIST: "6.0 6.1 7.0 7.5 8.0 8.6 8.9 9.0"
          MAX_JOBS: "2"

      - name: Upload wheel artifact
        uses: actions/upload-artifact@v4
        with:
          name: diffoctreerast-binary-wheel-py311-cu118-win_amd64
          path: dist/*.whl
          retention-days: 30

      - name: Test wheel installation
        run: |
          Write-Host "=== Creating test environment ==="
          python -m venv test_env
          .\test_env\Scripts\Activate.ps1

          Write-Host "`n=== Installing PyTorch in test env ==="
          pip install torch==2.2.2 --extra-index-url https://download.pytorch.org/whl/cu118

          Write-Host "`n=== Installing built wheel ==="
          $wheel = Get-ChildItem dist\*.whl | Select-Object -First 1
          pip install $wheel.FullName

          Write-Host "`n=== Testing import ==="
          python -c "import diffoctreerast; print('[OK] diffoctreerast imported successfully')"

          Write-Host "`n=== Verifying pre-compiled extension ==="
          python -c "import torch; import diffoctreerast._C; print('[OK] Pre-compiled CUDA extension found')"
        shell: powershell

      - name: Display build summary
        run: |
          Write-Host "`n=========================================="
          Write-Host "âœ… BUILD SUCCESSFUL!"
          Write-Host "=========================================="
          Write-Host "`nBuilt wheel:"
          Get-ChildItem dist\*.whl | ForEach-Object {
              Write-Host "  ðŸ“¦ $($_.Name)"
              Write-Host "     Size: $([math]::Round($_.Length / 1MB, 2)) MB"
          }
          Write-Host "`nðŸ“¥ To download:"
          Write-Host "  1. Go to Actions tab in GitHub"
          Write-Host "  2. Click on this workflow run"
          Write-Host "  3. Download artifact from 'Artifacts' section"
        shell: powershell
